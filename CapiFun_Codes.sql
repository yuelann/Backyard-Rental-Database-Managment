/*
Course: INSY437: Managing data and database
Title: Term project
Submission date : 2023-04-19
Team Number: 6
Students' Name and McGill ID : Camila Loyola Riodriguez 261044780, Elaine Yu 261030551, Jeremy Gadoua 260983904, Nemanja Gmitrovic 261055389, Tina Dimova 260986550
*/

-- RDBMS Creation script

CREATE TABLE HOST(
	HOST_ID VARCHAR(6),
	FIRST_NAME VARCHAR(30),
    LAST_NAME VARCHAR(30),
    PHONE VARCHAR(12),
    EMAIL VARCHAR(30),
    STREET_ADDRESS VARCHAR(70),
    CITY VARCHAR(30),
    PROVINCE CHAR(2),
    POSTAL_CODE VARCHAR(6),
    COUNTRY VARCHAR(30),
		PRIMARY KEY(HOST_ID));
    
CREATE TABLE PROPERTY(
	PROPERTY_ID VARCHAR(6),
	TYPE VARCHAR(30),
	TERRAIN VARCHAR(30),
	SIZE INTEGER,
	STREET_ADDRESS VARCHAR(70),
    CITY VARCHAR(30),
    PROVINCE CHAR(2),
    POSTAL_CODE VARCHAR(6),
    COUNTRY VARCHAR(30),
    HOST_ID VARCHAR(6) NOT NULL,
		PRIMARY KEY(PROPERTY_ID),
		FOREIGN KEY (HOST_ID) REFERENCES HOST(HOST_ID));

CREATE TABLE AMENITY(
	AMENITY_ID VARCHAR(6),
	NAME VARCHAR(30),
	QUANTITY INTEGER,
	DESCRIPTION VARCHAR(100),
		PRIMARY KEY (AMENITY_ID));
    
    
CREATE TABLE INCLUDED(
	PROPERTY_ID VARCHAR(6),
	AMENITY_ID VARCHAR(6),
		PRIMARY KEY (PROPERTY_ID, AMENITY_ID),
		FOREIGN KEY (PROPERTY_ID) REFERENCES PROPERTY(PROPERTY_ID),
		FOREIGN KEY (AMENITY_ID) REFERENCES AMENITY(AMENITY_ID));
    
    
CREATE TABLE LISTING(
	LISTING_ID VARCHAR(6),
	NAME VARCHAR(70),
	HOURLY_PRICE INTEGER,
	DATE_LISTED DATETIME,
	DATE_AVAILABLE DATETIME,
	DURATION INTEGER,
    PROPERTY_ID VARCHAR(6) NOT NULL,
    HOST_ID VARCHAR(6) NOT NULL,
        PRIMARY KEY(LISTING_ID),
		FOREIGN KEY (PROPERTY_ID) REFERENCES PROPERTY(PROPERTY_ID),
		FOREIGN KEY (HOST_ID) REFERENCES HOST(HOST_ID));


CREATE TABLE RENTER(
    RENTER_ID VARCHAR(6),
    FIRST_NAME VARCHAR(30),
    LAST_NAME VARCHAR(30),
    PHONE VARCHAR(12),
    EMAIL VARCHAR(30),
    STREET_ADDRESS VARCHAR(70),
    CITY VARCHAR(30),
    PROVINCE CHAR(2),
    POSTAL_CODE VARCHAR(6),
    COUNTRY VARCHAR(30),
        PRIMARY KEY(RENTER_ID));
        

CREATE TABLE RESERVATION(
    RESERVATION_ID VARCHAR(6),
    START_DATE DATETIME,
    END_DATE DATETIME,
    HOURS INTEGER,
    LISTING_ID VARCHAR(6) NOT NULL,
    RENTER_ID VARCHAR(6) NOT NULL,
        PRIMARY KEY(RESERVATION_ID),
        FOREIGN KEY (LISTING_ID) REFERENCES LISTING(LISTING_ID),
        FOREIGN KEY (RENTER_ID) REFERENCES RENTER(RENTER_ID));


CREATE TABLE PAYMENT(
    PAYMENT_ID VARCHAR(6),
    TOTAL INTEGER,
    TYPE VARCHAR(30),
    DATE DATETIME,
    RENTER_ID VARCHAR(6) NOT NULL,
    RESERVATION_ID VARCHAR(6) NOT NULL,
        PRIMARY KEY(PAYMENT_ID),
        FOREIGN KEY (RENTER_ID) REFERENCES RENTER(RENTER_ID), 
        FOREIGN KEY (RESERVATION_ID) REFERENCES RESERVATION(RESERVATION_ID)); 


CREATE TABLE REVIEW(
    REVIEW_ID VARCHAR(6),
    SCORE INTEGER,
    DESCRIPTION VARCHAR(100),
    DATE DATETIME,
    LIKES INTEGER,
    LISTING_ID VARCHAR(6) NOT NULL,
    RENTER_ID VARCHAR(6) NOT NULL,
    SUB_REVIEW VARCHAR(6),
        PRIMARY KEY(REVIEW_ID),
        FOREIGN KEY (LISTING_ID) REFERENCES LISTING(LISTING_ID),
        FOREIGN KEY (RENTER_ID) REFERENCES RENTER(RENTER_ID),
        FOREIGN KEY (SUB_REVIEW) REFERENCES REVIEW(REVIEW_ID));


-- HOST
INSERT INTO HOST VALUES('H00001', 'Nemanja', 'Gmitrovic', 5146274343, 'nemanja.gmitrovic@gmail.com', '9106 Cherry Road', 'Wallaceburg', 'ON', 'N8A9P9', 'Canada');
INSERT INTO HOST VALUES('H00002', 'Tina ', 'Dimova', 4386341298, 'tina.dimova@gmail.com', '29 Williams Avenue', 'Outer Nunavut', 'NU', 'X0A1H7', 'Canada');
INSERT INTO HOST VALUES('H00003', 'Camila ', 'Loyola', 4386770997, 'mila.loyola@outlook.com', '88 Jones St.', 'Saint-Bruno', 'QC', 'J3V4X8', 'Canada');
INSERT INTO HOST VALUES('H00004', 'Elaine', 'Yu', 5149325548, 'elaine.gu@gmail.com', '718 Shipley Lane', 'Grande-Anse', 'NB', 'E8N7A9', 'Canada');
INSERT INTO HOST VALUES('H00005', 'Jeremy', 'Gadoua', 4387201543, 'jeremy.gadoua@yahoo.com', '32 Sierra St.', 'LAssomption', 'QC', 'J5W2A5', 'Canada');


-- PROPERTY
INSERT INTO PROPERTY VALUES('PR0001', 'Mansion', 'Grass', 18644, '9106 Cherry Road', 'Wallaceburg', 'ON', 'N8A9P9', 'Canada', 'H00001');
INSERT INTO PROPERTY VALUES('PR0002', 'Cottage', 'Field', 15067, '29 Williams Avenue', 'Outer Nunavut', 'NU', 'X0A1H7', 'Canada', 'H00002');
INSERT INTO PROPERTY VALUES('PR0003', 'Seaside', 'Sand', 8033, '88 Jones St.', 'Saint-Bruno', 'QC', 'J3V4X8', 'Canada', 'H00003');
INSERT INTO PROPERTY VALUES('PR0004', 'House', 'Grass', 7348, '7836 E. Union Street', 'Beresford', 'NB', 'E8K7K7', 'Canada', 'H00004');
INSERT INTO PROPERTY VALUES('PR0005', 'House', 'Grass', 7002, '32 Sierra St.', 'LAssomption', 'QC', 'J5W2A5', 'Canada', 'H00005');


-- AMENITY
INSERT INTO AMENITY VALUES('A00001', 'Pool', 1, 'Below ground pool');
INSERT INTO AMENITY VALUES('A00002', 'BBQ', 1, 'Gas powered grill for all your grilling needs');
INSERT INTO AMENITY VALUES('A00003', 'Gazebo', 1, 'Romantic candlelight date night gazebo');
INSERT INTO AMENITY VALUES('A00004', 'Swing', 2, 'Comfy high swing');
INSERT INTO AMENITY VALUES('A00005', 'Hammock', 1, 'Cozy cloth waterproof hammock');

-- INCLUDED
INSERT INTO INCLUDED VALUES('PR0001', 'A00001');
INSERT INTO INCLUDED VALUES('PR0001', 'A00002');
INSERT INTO INCLUDED VALUES('PR0001', 'A00003');
INSERT INTO INCLUDED VALUES('PR0001', 'A00004');
INSERT INTO INCLUDED VALUES('PR0002', 'A00005');
INSERT INTO INCLUDED VALUES('PR0003', 'A00005');
INSERT INTO INCLUDED VALUES('PR0004', 'A00002');
INSERT INTO INCLUDED VALUES('PR0004', 'A00004');
INSERT INTO INCLUDED VALUES('PR0005', 'A00001');
INSERT INTO INCLUDED VALUES('PR0005', 'A00002');


-- LISTING
INSERT INTO LISTING VALUES('L00001', 'Beautiful Mansion backyard for rent', 350, '2022-05-21 12:45:02', '2022-06-01 12:45:02', 3, 'PR0001', 'H00001');
INSERT INTO LISTING VALUES('L00002', 'Backyard Nature Cottage Retreat', 215, '2021-04-21 1:40:10', '2021-05-01 1:40:10', 6, 'PR0002', 'H00002');
INSERT INTO LISTING VALUES('L00003', 'Seaside backyard perfect for sand castles', 250, '2020-06-13 5:30:15', '2020-07-01 5:30:15', 5, 'PR0003', 'H00003');
INSERT INTO LISTING VALUES('L00004', 'Best backyard for a BBQ', 180, '2019-05-22 3:34:05', '2019-06-01 3:34:05', 4, 'PR0004', 'H00004');
INSERT INTO LISTING VALUES('L00005', 'Backyard with Underground Pool', 200, '2021-03-23 10:12:13', '2021-04-01 10:12:13', 6, 'PR0005', 'H00005');


-- RENTER
INSERT INTO RENTER VALUES('KS0001', 'Konstantin', 'Stankovic', 5146274343, 'pepelover@gmail.com', '8754 Kingston St.', 'Aylmer', 'ON', 'N5H5K2', 'Canada');
INSERT INTO RENTER VALUES('YM0002', 'Yuliya', 'Mihov', 4386341298, 'yuliyaflower@gmail.com', '337 La Sierra St.', 'Pembroke', 'ON', 'K8B0L0', 'Canada');
INSERT INTO RENTER VALUES('FM0003', 'Felipa', 'Maria', 4386770997, 'felipaaaa23@yahoo.com', '8075 Illinois Rd.', 'Digby Neck', 'NS', 'B0V6M8', 'Canada');
INSERT INTO RENTER VALUES('FR0004', 'Fanny', 'Ryer', 5149325548, 'ryerfanfan98@gmail.com', '583 Sunset Street', 'Kimberley', 'BC', 'V1A5G6', 'Canada');
INSERT INTO RENTER VALUES('FR0005', 'Flynn', 'Rider', 4387201543, 'theygotmynosewrong@gmail.com', '7836 E. Union Street', 'Beresford', 'NB', 'E8K7K7', 'Canada');


-- RESERVATION
INSERT INTO RESERVATION VALUES('R00001', '2022-06-21 12:45:02', '2022-06-21 13:45:02', 1, 'L00001', 'KS0001');
INSERT INTO RESERVATION VALUES('R00002', '2021-05-21 13:40:10', '2021-05-21 17:40:10', 4, 'L00002', 'YM0002');
INSERT INTO RESERVATION VALUES('R00003', '2020-07-13 5:30:15',  '2020-07-13 19:30:15', 2, 'L00003', 'FM0003');
INSERT INTO RESERVATION VALUES('R00004', '2019-06-22 3:34:05',  '2019-06-22 18:34:05', 2, 'L00005', 'FR0004');
INSERT INTO RESERVATION VALUES('R00005', '2021-04-23 10:12:13', '2021-04-23 12:12:13', 3, 'L00005', 'FR0005');


-- PAYMENT
INSERT INTO PAYMENT VALUES('PA0001', 350, 'Credit', '2022-06-19 12:45:02', 'KS0001', 'R00001');
INSERT INTO PAYMENT VALUES('PA0002', 860, 'Credit', '2021-05-20 13:40:10', 'YM0002', 'R00002');
INSERT INTO PAYMENT VALUES('PA0003', 500, 'Debit', '2020-07-12 17:30:15', 'FM0003', 'R00003');
INSERT INTO PAYMENT VALUES('PA0004', 360, 'Paypal', '2019-06-22 12:34:05', 'FR0004', 'R00004');
INSERT INTO PAYMENT VALUES('PA0005', 600, 'Debit', '2021-04-23 8:12:13', 'FR0005', 'R00005');


-- REVIEW
INSERT INTO REVIEW VALUES('C00001', 5, '4 acres of destinguished greenery', '2022-06-22 13:45:02', 5, 'L00001', 'KS0001', NULL);
INSERT INTO REVIEW VALUES('C00002', 3, 'Not bad, but wish we had access to the pool', '2021-05-22 17:40:10', 10, 'L00002', 'YM0002', NULL);
INSERT INTO REVIEW VALUES('C00003', 3, 'No bathroom access', '2020-07-14 19:30:15', 14, 'L00003', 'FM0003', NULL);
INSERT INTO REVIEW VALUES('C00005', 4, 'I also hosted my 3 year olds birthday there. It was lovely but too many mosquitoes', '2021-04-24 12:12:13', 22, 'L00005', 'FR0005', NULL);
INSERT INTO REVIEW VALUES('C00004', 5, 'Great place for my sons birthday', '2019-06-23 18:34:05', 12, 'L00005', 'FR0004', 'C00005');

-- Functionnal SQL statements

-- Ref Number: 01
UPDATE LISTING
SET HOURLY_PRICE = 250
WHERE LISTING_ID = 'L00005';

-- Ref Number: 02
/* We included three statements for this reference number because the property_id is also present in the included and listing tables. 
Therefore, we must delete them there before being able to delete them in the property table. */
DELETE FROM INCLUDED
WHERE PROPERTY_ID = 'PR0004';
DELETE FROM LISTING
WHERE PROPERTY_ID = 'PR0004';
DELETE FROM PROPERTY
WHERE PROPERTY_ID = 'PR0004';

-- Ref Number: 03
SELECT COUNT(*)
FROM REVIEW
WHERE LISTING_ID = 'L00005';

-- Ref Number: 04
INSERT INTO RENTER VALUES('MJ0006', 'Michael', 'Jordan', 5147289044, 'goat@gmail.com', '40 Johnson Road', 'McAdam', 'NB', 'E6J5J8', 'Canada');

-- Ref Number: 05
CREATE TABLE HOST_REVIEW(
    HOST_REVIEW_ID VARCHAR(6),
    SCORE INTEGER,
    DESCRIPTION VARCHAR(100),
    DATE DATETIME,
    LIKES INTEGER,
    HOST_ID VARCHAR(6) NOT NULL,
    RENTER_ID VARCHAR(6) NOT NULL,
    SUB_HOST_REVIEW VARCHAR(6),
        PRIMARY KEY(HOST_REVIEW_ID),
        FOREIGN KEY (HOST_ID) REFERENCES HOST(HOST_ID),
        FOREIGN KEY (RENTER_ID) REFERENCES RENTER(RENTER_ID),
        FOREIGN KEY (SUB_HOST_REVIEW) REFERENCES HOST_REVIEW(HOST_REVIEW_ID));



-- Informational SQL statements

-- Ref Number: 01
SELECT PROPERTY.TYPE, AVG( LISTING.HOURLY_PRICE ) AS AVERAGE_PRICE
FROM LISTING
JOIN PROPERTY ON LISTING.PROPERTY_ID = PROPERTY.PROPERTY_ID 
GROUP BY PROPERTY.TYPE
ORDER BY AVERAGE_PRICE DESC;

-- Ref Number: 02
SELECT NAME, PROVINCE, COUNT( NAME ) AS NUMBEROFAMENITY
FROM AMENITY 
JOIN INCLUDED ON AMENITY.AMENITY_ID = INCLUDED.AMENITY_ID 
JOIN PROPERTY ON INCLUDED.PROPERTY_ID = PROPERTY.PROPERTY_ID 
GROUP BY PROVINCE, NAME;

-- Ref Number: 03
SELECT TYPE, COUNT( TYPE ) AS METHODCOUNT 
FROM PAYMENT
GROUP BY TYPE
ORDER BY METHODCOUNT DESC;

-- Ref Number: 04
SELECT LISTING.NAME, REVIEW.SCORE
FROM LISTING
JOIN REVIEW ON LISTING.LISTING_ID = REVIEW.LISTING_ID
WHERE REVIEW.SCORE > ( SELECT AVG( SCORE ) FROM REVIEW );

-- Ref Number: 05
SELECT COUNT(*) as Num_New_Listings
FROM LISTING
WHERE DATE_LISTED >= '2021-01-01' AND DATE_LISTED < '2023-01-01' AND HOURLY_PRICE*DURATION<=1250;

-- Ref Number: 06
SELECT REVIEW_ID, DESCRIPTION,LIKES
FROM 
  REVIEW
WHERE 
  LIKES >= 5 AND (
    DESCRIPTION LIKE '%bathroom%' OR 
    DESCRIPTION LIKE '%pool%' OR 
    DESCRIPTION LIKE '%amenities%' OR 
    DESCRIPTION LIKE '%terrain%'
  )
ORDER BY 
  LIKES DESC;

-- Ref Number: 07
SELECT COUNTRY, COUNT(PROPERTY_ID) AS NUMBEROFPROPERTIES
FROM PROPERTY
GROUP BY COUNTRY;

-- Ref Number: 08
SELECT LENGTH(DESCRIPTION) AS NUM_WORDS, COUNT(*) AS NUM_REVIEWS, AVG(LIKES) AS AVG_LIKES
FROM REVIEW
WHERE LENGTH(DESCRIPTION) > 0
GROUP BY NUM_WORDS;

-- Ref Number: 09
SELECT PROVINCE, COUNT(HOST.HOST_ID) / COUNT(HOST.HOST_ID) AS RATIO
FROM HOST
JOIN LISTING ON HOST.HOST_ID = LISTING.HOST_ID
JOIN REVIEW ON LISTING.LISTING_ID = REVIEW.LISTING_ID
JOIN RENTER ON REVIEW.RENTER_ID = RENTER.RENTER_ID
GROUP BY PROVINCE;


-- Ref Number: 10
SELECT l.NAME, l.HOURLY_PRICE, p.TYPE
FROM LISTING l JOIN PROPERTY p ON l.PROPERTY_ID = p.PROPERTY_ID
WHERE l.HOURLY_PRICE < ( SELECT AVG( l2.HOURLY_PRICE ) 
FROM LISTING l2 JOIN PROPERTY p2 ON l2.PROPERTY_ID = p2.PROPERTY_ID WHERE p2.TYPE = p.TYPE );


-- Graph database Cypher creation statements

-- Ref Number: 11

CREATE 
	(r1: RENTER {RENTER_ID: "KS0001", FIRST_NAME: "Konstantin", LAST_NAME: "Stankovic", PHONE_NUMBER: "Stankovic", EMAIL: "pepelover@gmail.com", STREET_ADDRESS: "8754 Kingston St.", CITY: "Aylmer", PROVINCE: "ON", POSTAL_CODE: "N5H5K2", COUNTRY: "Canada"}), 
	(r2: RENTER {RENTER_ID: "YM0002", FIRST_NAME: "Yuliya", LAST_NAME: "Mihov", PHONE_NUMBER: "4386341298", EMAIL: "yuliyaflower@gmail.com", STREET_ADDRESS: "337 La Sierra St.", CITY: "Pembroke", PROVINCE: "ON", POSTAL_CODE: "K8B0L0", COUNTRY: "Canada"}),
	(r3: RENTER {RENTER_ID: "FM0003", FIRST_NAME: "Felipa", LAST_NAME: "Maria", PHONE_NUMBER: "4386770997", EMAIL: "felipaaaa23@yahoo.com", STREET_ADDRESS: "8075 Illinois Rd.", CITY: "Digby Neck", PROVINCE: "NS", POSTAL_CODE: "B0V6M8", COUNTRY: "Canada"}),
	(r4: RENTER {RENTER_ID: "FR0004", FIRST_NAME: "Fanny", LAST_NAME: "Ryer", PHONE_NUMBER: "5149325548", EMAIL: "ryerfanfan98@gmail.com", STREET_ADDRESS: "583 Sunset Street", CITY: "Kimberley", PROVINCE: "BC", POSTAL_CODE: "V1A5G6", COUNTRY: "Canada"}),
	(r5: RENTER {RENTER_ID: "FR0005", FIRST_NAME: "Flynn",LAST_NAME: "Rider", PHONE_NUMBER: "4387201543", EMAIL: "theygotmynosewrong@gmail.com", HOME_ADDRESS: "7836 E. Union Street", CITY: "Beresford", PROVINCE: "NB", POSTAL_CODE: "E8K7K7", COUNTRY: "Canada"}),
	(c1: REVIEW {REVIEW_ID: "C00001", SCORE: 5, DESCRIPTION: "4 acres of destinguished greenery", NUMBER_OF_LIKES: 5}),
	(c2: REVIEW {REVIEW_ID: "C00002", SCORE: 3, DESCRIPTION: "Not bad, but wish we had access to the pool", NUMBER_OF_LIKES: 10}),
	(c3: REVIEW {REVIEW_ID: "C00003", SCORE: 3, DESCRIPTION: "No bathroom access", NUMBER_OF_LIKES: 14}),
	(c4: REVIEW {REVIEW_ID: "C00004", SCORE: 5, DESCRIPTION: "Great place for my son's birthday", NUMBER_OF_LIKES: 12}),
	(c5: REVIEW {REVIEW_ID: "C00005", SCORE: 4, DESCRIPTION: "I also hosted my 3 year old's birthday there. It was lovely but too many mosquitoes", NUMBER_OF_LIKES: 22}),
	(r1)-[: WRITES {Date: date('2022-6-22')}]->(c1),
	(r2)-[: WRITES {Date: date('2021-5-22')}]->(c2),
	(r3)-[: WRITES {Date: date('2020-7-14')}]->(c3),
	(r4)-[: WRITES {Date: date('2019-6-23')}]->(c4),
	(r5)-[: WRITES {Date: date('2021-4-24')}]->(c5),
	(r1)-[: LIKES {Date: date('2021-6-29')}]->(c3),
   	(r1)-[: LIKES {Date: date('2021-7-24')}]->(c2),
  	(r2)-[: LIKES {Date: date('2021-8-13')}]->(c5),
 	(r3)-[: LIKES {Date: date('2022-8-30')}]->(c1),
	(r5)-[: LIKES {Date: date('2020-9-11')}]->(c3),
 	(r2)-[: LIKES {Date: date('2020-8-09')}]->(c3),
	(r5)-[: LIKES {Date: date('2022-7-15')}]->(c2),
	(c1)-[: REPLIES {Date: date('2022-7-12')}]->(c2),
	(c3)-[: REPLIES {Date: date('2022-8-05')}]->(c5)

RETURN r1,r2,r3,r4,c1,c2,c3,c4,c5;

-- Cypher queries

-- Ref Number: 12

MATCH (R1:RENTER) - [W:WRITES] -> (C:REVIEW) <- [L:LIKES] - (R2:RENTER) 
	WHERE C.SCORE <= 3
	RETURN DISTINCT C.REVIEW_ID, R1.RENTER_ID, R1.FIRST_NAME, R1.LAST_NAME, COUNT(C) AS NUMBER_OF_LIKES
	ORDER BY NUMBER_OF_LIKES DESC;

-- Ref Number: 13

MATCH (C:REVIEW) <- [W:WRITES] - (R:RENTER) 
	WHERE W.Date >= date(“2022-01-01”)
	RETURN DISTINCT C.REVIEW_ID, C.DESCRIPTION;

